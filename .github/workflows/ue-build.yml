name: UE Build

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:
    inputs:
      tag:
        description: Optional tag name to create and release
        required: false

# If your runner sets UE_ENGINE_ROOT as a machine env var,
# you can remove the env block or leave it to override via secret.
env:
  UE_ENGINE_ROOT: ${{ secrets.UE_ENGINE_ROOT }}
  PROJECT: UEGitWorkshop.uproject

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-linux:
    # Do not run on forked PRs for self-hosted security
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
    runs-on: ubuntu-latest
    container:
      image: ${{ secrets.UE_DOCKER_IMAGE }}
      options: --user 0
    timeout-minutes: 120
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate UE engine path (in container)
        shell: bash
        run: |
          ENGINE_PATH="${UE_ENGINE_ROOT}"
          if [[ -z "${ENGINE_PATH}" ]]; then
            for candidate in /opt/UnrealEngine /opt/unreal-engine /home/ue4/UnrealEngine /home/ue/UnrealEngine; do
              if [[ -d "$candidate" ]]; then ENGINE_PATH="$candidate"; break; fi
            done
          fi
          if [[ -z "${ENGINE_PATH}" || ! -d "${ENGINE_PATH}" ]]; then
            echo "Unable to locate Unreal Engine in container. Set secret UE_ENGINE_ROOT or bake engine into image at one of: /opt/UnrealEngine, /opt/unreal-engine, /home/ue4/UnrealEngine, /home/ue/UnrealEngine" >&2
            exit 1
          fi
          echo "Engine path: ${ENGINE_PATH}"
          echo "UE_ENGINE_ROOT=${ENGINE_PATH}" >> "$GITHUB_ENV"

      - name: Build (Editor target)
        shell: bash
        run: |
          echo "Python version:"
          python -V
          echo "Building with engine at ${UE_ENGINE_ROOT}"
          python build_ue.py --project "${PROJECT}" --engine "${UE_ENGINE_ROOT}" --config Development --platform Linux

      - name: Create archives
        if: success()
        shell: bash
        run: |
          if [[ -d "Binaries/Linux" ]]; then zip -r "Binaries-Linux.zip" "Binaries/Linux" || true; fi
          if [[ -d "Saved/Logs" ]]; then zip -r "Logs.zip" "Saved/Logs" || true; fi

      - name: Upload build outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Binaries-Linux
          path: |
            Binaries/Linux/**
            Saved/Logs/**
            Binaries-Linux.zip
            Logs.zip

      - name: Compute tag
        id: version
        if: ${{ github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}
        shell: bash
        env:
          INPUT_TAG: ${{ github.event.inputs.tag }}
        run: |
          if [[ -n "${INPUT_TAG}" ]]; then tag="${INPUT_TAG}"; else tag="build-$(date +'%Y%m%d')-${{ github.run_number }}"; fi
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "Tag computed: ${tag}"

      - name: Push git tag
        if: ${{ steps.version.outputs.tag != '' }}
        shell: bash
        env:
          TAG: ${{ steps.version.outputs.tag }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch --tags --force
          git tag "${TAG}" -a -m "Automated build ${TAG}" || git tag "${TAG}" -fa -m "Automated build ${TAG}"
          git push origin "${TAG}" --force-with-lease || git push origin "${TAG}"

      - name: Create GitHub Release
        if: ${{ steps.version.outputs.tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Automated build ${{ steps.version.outputs.tag }}
          body: |
            Automated build from commit ${{ github.sha }} on ${{ github.ref }}.
            Trigger: ${{ github.event_name }} | Runner: ${{ runner.os }}
          files: |
            Binaries-Linux.zip
            Logs.zip

  build-game:
    # Do not run on forked PRs for self-hosted security
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
    runs-on: ubuntu-latest
    container:
      image: ${{ secrets.UE_DOCKER_IMAGE }}
      options: --user 0
    needs: build-linux
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Validate UE engine path (in container)
        shell: bash
        run: |
          ENGINE_PATH="${UE_ENGINE_ROOT}"
          if [[ -z "${ENGINE_PATH}" ]]; then
            for candidate in /opt/UnrealEngine /opt/unreal-engine /home/ue4/UnrealEngine /home/ue/UnrealEngine; do
              if [[ -d "$candidate" ]]; then ENGINE_PATH="$candidate"; break; fi
            done
          fi
          if [[ -z "${ENGINE_PATH}" || ! -d "${ENGINE_PATH}" ]]; then
            echo "Unable to locate Unreal Engine in container. Set secret UE_ENGINE_ROOT or bake engine into image at one of: /opt/UnrealEngine, /opt/unreal-engine, /home/ue4/UnrealEngine, /home/ue/UnrealEngine" >&2
            exit 1
          fi
          echo "Engine path: ${ENGINE_PATH}"
          echo "UE_ENGINE_ROOT=${ENGINE_PATH}" >> "$GITHUB_ENV"
      - name: Build (Game target)
        shell: bash
        run: |
          python build_ue.py --project "${PROJECT}" --engine "${UE_ENGINE_ROOT}" --config Development --platform Linux --game
      - name: Upload Game Binaries
        uses: actions/upload-artifact@v4
        with:
          name: Game-Binaries-Linux
          path: |
            Binaries/Linux/**
            Saved/Logs/**
