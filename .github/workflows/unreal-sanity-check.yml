name: Unreal Sanity Check

on:
  push:
    branches: [ main, master, dev ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

env:
  PROJECT: UEGitWorkshop.uproject

jobs:
  sanity:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Ensure LFS files are real (not pointers)
        shell: bash
        run: |
          set -euo pipefail
          git lfs version || true
          git lfs install --local || true
          git lfs fetch --all || true
          git lfs checkout || true

      - name: Basic repo sanity
        shell: bash
        run: |
          set -euo pipefail
          echo "Branch: $GITHUB_REF" | tee sanity.txt
          echo "Commit: $GITHUB_SHA" | tee -a sanity.txt
          echo "Runner: $RUNNER_OS" | tee -a sanity.txt
          if [ -f "$PROJECT" ]; then
            echo "Found uproject: $PROJECT" | tee -a sanity.txt
          else
            echo "ERROR: Missing .uproject file: $PROJECT" | tee -a sanity.txt
            exit 1
          fi
          echo "Top 50 tracked files:" | tee -a sanity.txt
          git ls-files | head -n 50 | tee -a sanity.txt

      - name: Whitespace/EOL check
        shell: bash
        run: |
          set -euo pipefail
          if git diff --check > ws.txt 2>&1; then
            echo "No whitespace errors detected" | tee -a sanity.txt
            echo "Whitespace check passed: git diff --check reported no issues." > ws.txt
          else
            echo "Whitespace issues detected (see ws.txt)" | tee -a sanity.txt
            {
              echo "Whitespace check failed: git diff --check output below."
              echo "-------------------------------------------------------"
              cat ws.txt
            } > ws_tmp.txt
            mv ws_tmp.txt ws.txt
          fi

      - name: Naming convention check
        shell: bash
        run: |
          set -euo pipefail
          python3 --version
          python3 scripts/validate_naming.py --content Content --report naming.txt | tee -a sanity.txt

      - name: Verify README tree snapshot
        shell: bash
        run: |
          set -euo pipefail
          python3 scripts/update_tree_snapshot.py
          if ! git diff --quiet -- README.md; then
            echo "README tree snapshot is outdated. Run 'make snapshot' locally." | tee -a sanity.txt
            git diff -- README.md
            exit 1
          fi

      - name: Upload sanity report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sanity-report
          path: |
            sanity.txt
            ws.txt
            naming.txt
            README.md
            Logs.zip
            scripts/validate_naming.py
          if-no-files-found: ignore
