name: Game Build

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:
    inputs:
      tag:
        description: Optional tag name to create and release
        required: false

# If your Windows self-hosted runner sets UE_ENGINE_ROOT as a machine env var,
# you can keep this to override via secret there. Linux jobs override it to "".
env:
  UE_ENGINE_ROOT: ${{ secrets.UE_ENGINE_ROOT }}
  PROJECT: UEGitWorkshop.uproject

permissions:
  contents: write
  packages: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish-windows-zip:
    # Do not run on forked PRs for security (secrets not exposed)
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      WINDOWS_GAME_ZIP_URL: ${{ secrets.WINDOWS_GAME_ZIP_URL }}
      WINDOWS_GAME_ZIP_SHA256: ${{ secrets.WINDOWS_GAME_ZIP_SHA256 }}
    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
      
      - name: Ensure LFS files are real (not pointers)
        shell: bash
        run: |
          set -euo pipefail
          git lfs fetch --all
          git lfs checkout

      - name: Prepare Windows build zip
        id: prepare
        shell: bash
        run: |
          set -euo pipefail
          ZIP_PATH=""
          if [[ -n "${WINDOWS_GAME_ZIP_URL:-}" ]]; then
            echo "Downloading Windows build from URL..."
            curl -fsSLo Windows-Game.zip "${WINDOWS_GAME_ZIP_URL}"
            if [[ -n "${WINDOWS_GAME_ZIP_SHA256:-}" ]]; then
              echo "${WINDOWS_GAME_ZIP_SHA256}  Windows-Game.zip" | sha256sum -c -
            fi
            ZIP_PATH="$PWD/Windows-Game.zip"
          else
            echo "No WINDOWS_GAME_ZIP_URL secret set. Searching repository for a zip..."
            CANDIDATE="$(ls -1 Builds/Windows/*.zip Releases/*.zip windows/*.zip 2>/dev/null | head -n1 || true)"
            if [[ -n "${CANDIDATE}" ]]; then
              ZIP_PATH="$PWD/${CANDIDATE}"
              echo "Found zip: ${ZIP_PATH}"
            else
              echo "No Windows build zip provided or found; skipping artifact/upload steps."
            fi
          fi
          echo "ZIP_PATH=${ZIP_PATH}" >> "$GITHUB_OUTPUT"
          echo "ZIP_PATH=${ZIP_PATH}" >> "$GITHUB_ENV"

      - name: Upload Windows Build artifact
        if: ${{ steps.prepare.outputs.ZIP_PATH != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Game
          path: ${{ steps.prepare.outputs.ZIP_PATH }}

      - name: Compute tag
        id: version
        if: ${{ (github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && steps.prepare.outputs.ZIP_PATH != '' }}
        shell: bash
        env:
          INPUT_TAG: ${{ github.event.inputs.tag }}
        run: |
          set -euo pipefail
          if [[ -n "${INPUT_TAG:-}" ]]; then tag="${INPUT_TAG}"; else tag="release-$(date +'%Y%m%d')-${{ github.run_number }}"; fi
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "Tag computed: ${tag}"

      - name: Push git tag
        if: ${{ steps.version.outputs.tag != '' }}
        shell: bash
        env:
          TAG: ${{ steps.version.outputs.tag }}
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch --tags --force
          git tag "${TAG}" -a -m "Automated release ${TAG}" || git tag "${TAG}" -fa -m "Automated release ${TAG}"
          git push origin "${TAG}" --force-with-lease || git push origin "${TAG}"

      - name: Create GitHub Release
        if: ${{ steps.version.outputs.tag != '' && steps.prepare.outputs.ZIP_PATH != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Windows build ${{ steps.version.outputs.tag }}
          body: |
            Packaged Windows build from commit ${{ github.sha }} on ${{ github.ref }}.
            Trigger: ${{ github.event_name }} | Runner: ${{ runner.os }}
          files: |
            ${{ steps.prepare.outputs.ZIP_PATH }}
