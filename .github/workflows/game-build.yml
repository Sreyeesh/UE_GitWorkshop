name: Package Windows Game

on:
  workflow_dispatch:
    inputs:
      config:
        description: Build config (Development or Shipping)
        default: Shipping
        required: true
      tag:
        description: Optional tag (e.g. v0.1.0)
        required: false

# If your Windows self-hosted runner sets UE_ENGINE_ROOT as a machine env var,
# you can keep this to override via secret there. Linux jobs override it to "".
env:
  UE_ENGINE_ROOT: ${{ secrets.UE_ENGINE_ROOT }}
  PROJECT: UEGitWorkshop.uproject

permissions:
  contents: write

 

jobs:
  package-windows:
    # Donâ€™t run on forked PRs for safety
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
    runs-on: [self-hosted, Windows, ue5]
    timeout-minutes: 120
    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Ensure LFS files are real (not pointers)
        shell: pwsh
        run: |
          git lfs fetch --all
          git lfs checkout

      - name: Validate UE engine path
        shell: pwsh
        run: |
          if (-not $env:UE_ENGINE_ROOT) { Write-Error 'UE_ENGINE_ROOT secret/env var not set'; exit 1 }
          if (-not (Test-Path $env:UE_ENGINE_ROOT)) { Write-Error "UE_ENGINE_ROOT path not found: $env:UE_ENGINE_ROOT"; exit 1 }
          Write-Host "Engine path: $env:UE_ENGINE_ROOT"

      # For Blueprint-only projects you can add -nocompile to skip compiling altogether.
      - name: Package game
        shell: pwsh
        run: |
          $Engine = "$env:UE_ENGINE_ROOT"
          $Project = "$env:PROJECT"
          $OutDir = "PackagedBuild"
          if (Test-Path $OutDir) { Remove-Item $OutDir -Recurse -Force }

          & "$Engine\Build\BatchFiles\RunUAT.bat" BuildCookRun `
            -project="$Project" `
            -noP4 -platform=Win64 -clientconfig="${{ github.event.inputs.config }}" `
            -cook -allmaps -build -stage -pak -archive `
            -archivedirectory="$PWD\$OutDir"

          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Zip packaged build
        shell: pwsh
        run: |
          Compress-Archive -Path "PackagedBuild\*" -DestinationPath "WindowsGame.zip" -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: WindowsGame
          path: |
            WindowsGame.zip

      - name: Compute tag
        id: tag
        shell: pwsh
        env:
          INPUT_TAG: ${{ github.event.inputs.tag }}
        run: |
          if ($env:INPUT_TAG) { $tag = $env:INPUT_TAG }
          else { $tag = "game-" + (Get-Date -Format 'yyyyMMdd') + "-${{ github.run_number }}" }
          "tag=$tag" >> $env:GITHUB_OUTPUT
          Write-Host "Tag: $tag"

      - name: Push git tag
        if: ${{ steps.tag.outputs.tag != '' }}
        shell: pwsh
        env:
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch --tags --force
          git tag $env:TAG -a -m "Packaged game $env:TAG" || git tag $env:TAG -fa -m "Packaged game $env:TAG"
          git push origin $env:TAG --force-with-lease || git push origin $env:TAG

      - name: Create GitHub Release
        if: ${{ steps.tag.outputs.tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Windows game ${{ steps.tag.outputs.tag }}
          body: |
            Packaged Windows game build from commit ${{ github.sha }}.
          files: |
            WindowsGame.zip
